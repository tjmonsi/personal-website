## Infrastructure Specifications

### Google Cloud Project

- **Project**: *To be created / named*
- **Region**: *See Clarification CLR-010*
- **Billing**: *Budget to be determined*

---

### Components

#### INFRA-001: Firebase Hosting

**Purpose**: Serve the Nuxt 4 SPA static assets globally.

**Configuration**:

- Hosting target: Static files generated by Nuxt 4 build (`nuxt generate`)
- Custom domain: *To be configured*
- SSL/TLS: Managed by Firebase (automatic)
- Cache headers:
  - HTML files: `Cache-Control: no-cache` (always revalidate)
  - JS/CSS/assets with hash: `Cache-Control: public, max-age=31536000, immutable`
  - Images: `Cache-Control: public, max-age=86400`
- Rewrite rules: All non-asset routes rewrite to `index.html` (SPA mode)

---

#### INFRA-002: Firebase Functions

**Purpose**: *See Clarification CLR-004*. The initial plan mentions Firebase Functions but also states "no server involved on Nuxt4." Functions may be used for:
- Serving `robots.txt` dynamically
- Handling tracking/error reporting if GET-only constraint is relaxed
- SSR if static mode is reconsidered

---

#### INFRA-003: Google Cloud Run

**Purpose**: Host the Go backend API.

**Configuration**:

| Setting              | Value                           |
| -------------------- | ------------------------------- |
| Container runtime    | Go binary in minimal Docker image |
| Min instances        | 0 (scale to zero)               |
| Max instances        | *TBD based on budget*           |
| CPU                  | 1 vCPU (initial)                |
| Memory               | 256 MB (initial)                |
| Concurrency          | 80 (default)                    |
| Request timeout      | 30 seconds                      |
| Startup CPU boost    | Enabled                         |
| Ingress              | Internal + Cloud Load Balancing |

**Docker Image**:

```dockerfile
# Multi-stage build
FROM golang:1.23-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o server .

FROM gcr.io/distroless/static-debian12
COPY --from=builder /app/server /server
EXPOSE 8080
ENTRYPOINT ["/server"]
```

**Health Check**: `GET /health` (returns `200` with `{"status": "ok"}`)

---

#### INFRA-004: Google Cloud Load Balancer

**Purpose**: Route traffic, SSL termination, and integration with Cloud Armor.

**Configuration**:

- Type: External Application Load Balancer (Global)
- Backend services:
  - Firebase Hosting (frontend)
  - Cloud Run (backend API)
- SSL Certificate: Google-managed
- URL Map routing:
  - `/api/*` → Cloud Run backend
  - `/*` → Firebase Hosting
  - *Or*: Separate subdomains (e.g., `api.tjmonserrat.com` → Cloud Run)

> **Note**: See Clarification CLR-010 for domain structure preference (path-based vs subdomain routing).

---

#### INFRA-005: Google Cloud Armor

**Purpose**: WAF and DDoS protection.

**Policies**:

| Rule Priority | Description                              | Action    |
| ------------- | ---------------------------------------- | --------- |
| 1000          | Block known malicious IP ranges          | Deny      |
| 2000          | Rate limiting (per IP)                   | Throttle  |
| 3000          | Block SQL injection patterns             | Deny      |
| 4000          | Block XSS patterns                       | Deny      |
| 5000          | Block path traversal attempts            | Deny      |
| 9999          | Default allow                            | Allow     |

**Rate Limiting at Cloud Armor level**:

- Threshold: *TBD* requests per minute per IP
- Action: HTTP `429` response
- Note: Application-level rate limiting (in Go) provides finer-grained control. Cloud Armor rate limiting serves as a first line of defense.

---

#### INFRA-006: Database

> See Clarification CLR-001 for database technology choice.

**If MongoDB Atlas on GCP**:

| Setting          | Value                              |
| ---------------- | ---------------------------------- |
| Cluster tier     | M0 (free) or M10 (production)     |
| Region           | Same as Cloud Run                  |
| Replica set      | 3 nodes (default for M10+)        |
| Backup           | Continuous backup enabled          |
| Network access   | Private endpoint or IP allowlist   |

**If Firestore (Native mode)**:

| Setting          | Value                              |
| ---------------- | ---------------------------------- |
| Mode             | Native                             |
| Location         | Same region as Cloud Run           |
| Security rules   | Deny all client access (backend only) |

---

#### INFRA-007: Google Cloud Logging & Monitoring

**Purpose**: Centralized observability.

**Configuration**:

- **Structured logging** from Cloud Run (JSON format)
- **Log sinks**: Route error logs to a dedicated log bucket with 90-day retention
- **Alerts**:
  - Error rate > 1% of requests over 5 minutes
  - Latency P95 > 2 seconds over 5 minutes
  - Cloud Run instance memory > 80%
  - Any masked 500 error logged
- **Dashboards**: Request rate, latency, error rate, Cloud Run instance count

---

### CI/CD Pipeline

**Tool**: GitHub Actions (assumed, given `.github/` directory exists)

**Pipeline stages**:

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│   Lint   │───▶│   Test   │───▶│  Build   │───▶│  Deploy  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
```

| Stage   | Frontend                        | Backend                        |
| ------- | ------------------------------- | ------------------------------ |
| Lint    | ESLint, Stylelint               | golangci-lint                  |
| Test    | Vitest (unit), Playwright (E2E) | `go test`                      |
| Build   | `nuxt generate`                 | Docker build                   |
| Deploy  | Firebase deploy                 | Cloud Run deploy               |

**Branch strategy**:
- `main` → Production
- `staging` → Staging environment
- Feature branches → PR preview (optional)

---

### Network Diagram

```
                    Internet
                       │
                       ▼
              ┌─────────────────┐
              │   Cloud DNS     │
              │  tjmonserrat.com│
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │  Cloud Armor    │
              │  (WAF / DDoS)   │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │  Cloud Load     │
              │  Balancer (L7)  │
              └───┬─────────┬───┘
                  │         │
        ┌─────────┘         └─────────┐
        ▼                             ▼
┌───────────────┐           ┌───────────────┐
│   Firebase    │           │   Cloud Run   │
│   Hosting     │           │   (Go API)    │
│   (SPA)       │           │   0-N inst.   │
└───────────────┘           └───────┬───────┘
                                    │
                                    ▼
                            ┌───────────────┐
                            │   Database    │
                            │   (CLR-001)   │
                            └───────────────┘
```
