---
title: Backend API Specifications
version: 2.9
date_created: 2026-02-17
last_updated: 2026-02-18
owner: TJ Monserrat
tags: [backend, api, go, cloud-run, breadcrumbs]
---

## Backend API Specifications

### Technology

- **Language**: Go
- **Runtime**: Google Cloud Run (asia-southeast1)
- **Network**: Behind Google Cloud Load Balancer + Cloud Armor
- **Database**: Firestore Enterprise (MongoDB compatibility mode) via MongoDB Go driver
- **Vector Database**: Firestore Native Mode via Firestore Go SDK (for semantic search)
- **Embedding**: Vertex AI Gemini `gemini-embedding-001` (for search query embedding)
- **Domain**: `api.tjmonsi.com`

### Global API Rules

#### Allowed HTTP Methods

- THE SYSTEM SHALL accept `GET` requests on all endpoints except `POST /t`.
- THE SYSTEM SHALL accept `POST` requests only on the `/t` endpoint (tracking and error reporting).
- THE SYSTEM SHALL accept `OPTIONS` requests on all endpoints for CORS preflight handling. `OPTIONS` requests SHALL return appropriate CORS headers (see SEC-006 in [06-security-specifications.md](06-security-specifications.md)) and SHALL NOT be subject to application-level ban checks. Cloud Armor rate limiting applies to all requests regardless of HTTP method; however, CORS preflight caching (`max-age: 86400`) makes OPTIONS rate limiting negligible in practice.
- WHEN a request uses any method other than the allowed method for an endpoint, THE SYSTEM SHALL return HTTP `405 Method Not Allowed` with an appropriate `Allow` header.

#### Error Response Strategy

- THE SYSTEM SHALL only return the following HTTP status codes to clients:
  - `200` — Success
  - `304` — Not Modified (conditional request response for article detail endpoints; see BE-API-003, BE-API-005)
  - `400` — Bad Request (invalid input)
  - `403` — Forbidden (blocked client, 30-day ban tier)
  - `404` — Not Found (resource does not exist, catch-all for masked errors, or indefinitely blocked client)
  - `405` — Method Not Allowed
  - `429` — Too Many Requests (rate limit exceeded or initial offense ban tier)
  - `503` — Service Unavailable (only for legitimate network/infrastructure failures)
  - `504` — Gateway Timeout (infrastructure-generated by Cloud Run when a request exceeds the 30-second timeout; not application-generated)
- **THE SYSTEM SHALL NEVER return HTTP `500` to clients.**
  - IF an internal server error occurs, THE SYSTEM SHALL return `404` to the client.
  - THE SYSTEM SHALL log the actual error with full context to Google Cloud Logging.

#### Error Logging (Internal)

- WHEN an internal error occurs, THE SYSTEM SHALL log:
  - Timestamp (UTC)
  - Request method and path
  - Query parameters (sanitized)
  - Client IP address
  - Error message and stack trace
  - Request ID / correlation ID
  - Server-side breadcrumb trail (see **BE-BREADCRUMB** below)

---

#### BE-BREADCRUMB: Server-Side Request Breadcrumb Trail

**Description**: A per-request, in-memory breadcrumb collector that records processing steps, variable state changes, and decision points during the handling of a single API request. When an internal error occurs, the breadcrumb trail is included in the structured error log to provide full debugging context in a single log entry.

**Requirements**:

- THE SYSTEM SHALL create a new breadcrumb collector at the start of every incoming HTTP request, scoped to that request's `context.Context`.
- THE SYSTEM SHALL propagate the collector through Go's `context.Context` so that any function in the request call chain can record breadcrumbs without passing an additional parameter.
- THE SYSTEM SHALL limit the breadcrumb buffer to a maximum of **50 entries** per request. If more than 50 entries are recorded, THE SYSTEM SHALL discard the oldest entry (FIFO eviction).
- THE SYSTEM SHALL record breadcrumb entries at the following processing points:

| Step Category        | When to Record                                                      | Data to Capture                                                                |
| -------------------- | ------------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| `request_received`   | At the start of request handling (middleware)                       | HTTP method, path, query parameters (sanitized), client IP (truncated)         |
| `auth_check`         | After authentication/authorization decision                        | Auth result (`pass`, `fail`, `ban_tier`), relevant identifiers                 |
| `validation`         | After input validation                                              | Validation result (`pass`, `fail`), which fields failed (no raw values)        |
| `db_query`           | Before and after each database operation                            | Collection name, operation type (`find`, `findOne`, `aggregate`), filter keys (not values), result count, latency (ms) |
| `cache_lookup`       | On cache check (hit or miss)                                       | Cache type (`embedding_cache`), key identifier, result (`hit`, `miss`) |
| `external_api_call`  | Before and after Vertex AI or other external API calls              | Service name, operation, latency (ms), status (`success`, `error`)             |
| `vector_search`      | After vector similarity search                                      | Collection queried, result count, distance threshold applied, candidates returned |
| `filter_applied`     | When filters are applied to query results                           | Filter names and operator types (not filter values), result count after filter |
| `pagination`         | When pagination is computed                                         | Page requested, page size, total items, total pages                            |
| `response_prepared`  | Just before sending the response                                    | HTTP status code, content type, response size (bytes)                          |
| `error`              | When an error is caught                                             | Error message, error type, source function name                                |
| `decision`           | At significant branching points (e.g., cache hit vs miss path)      | Decision description, chosen path                                              |
| `state_change`       | When a meaningful variable value changes during processing          | Variable name, old value summary, new value summary (no PII or secrets)        |

- Each breadcrumb entry SHALL conform to the following structure:

```go
type Breadcrumb struct {
    Timestamp time.Time              `json:"timestamp"`
    Step      string                 `json:"step"`
    Message   string                 `json:"message"`
    Data      map[string]interface{} `json:"data,omitempty"`
}
```

  - `timestamp`: UTC time with microsecond precision.
  - `step`: One of the step categories listed in the table above.
  - `message`: A short, human-readable description (max 300 characters).
  - `data`: Structured key-value pairs with diagnostic details. Values SHALL be strings, numbers, or booleans only (no nested objects or arrays).

- **Security and Privacy Constraints**:
  - THE SYSTEM SHALL NEVER record sensitive data in breadcrumbs: no JWT tokens, no API keys, no passwords, no full IP addresses, no raw user input values (query parameter values, request bodies), no database document contents.
  - For database queries, breadcrumbs SHALL record filter **keys** (field names) but NOT filter **values**. Example: `{"filter_keys": "category,tags", "operation": "find"}` — not `{"category": "DevOps", "tags": ["go"]}`.
  - For validation failures, breadcrumbs SHALL record **which fields** failed but NOT the submitted values.
  - Client IP addresses in breadcrumbs SHALL be truncated (same truncation as tracking: last octet zeroed for IPv4, last 80 bits zeroed for IPv6).

- **Integration with Error Logging**:
  - WHEN an internal error occurs, THE SYSTEM SHALL retrieve the breadcrumb trail from the current request context and include it as a `server_breadcrumbs` array in the structured error log entry emitted to Cloud Logging.
  - The `server_breadcrumbs` field SHALL appear alongside the existing error log fields (timestamp, method, path, query parameters, client IP, error message, stack trace, request ID).
  - This enables reading the full processing history of a failed request in a single Cloud Logging entry without correlating multiple log lines.

- **Performance Constraints**:
  - Breadcrumb recording SHALL NOT add more than **1 millisecond** of overhead to the total request processing time under normal conditions.
  - THE SYSTEM SHALL use a pre-allocated slice (capacity 50) to avoid repeated memory allocations.
  - THE SYSTEM SHALL NOT persist breadcrumbs to any external storage. Breadcrumbs exist only in memory for the duration of the request.
  - On successful requests (no errors), THE SYSTEM SHALL discard the breadcrumb buffer when the request completes. Breadcrumbs are only serialized and logged when an error occurs.

- **Example Error Log Entry with Breadcrumbs**:

```json
{
  "severity": "ERROR",
  "timestamp": "2026-02-18T10:30:01.123456Z",
  "request_id": "abc123-def456",
  "method": "GET",
  "path": "/technical",
  "query_params": "q=cloud+run&category=DevOps&page=2",
  "client_ip": "203.0.113.0",
  "error": "firestore: DeadlineExceeded",
  "stack_trace": "...",
  "server_breadcrumbs": [
    {
      "timestamp": "2026-02-18T10:30:00.100000Z",
      "step": "request_received",
      "message": "GET /technical with query params",
      "data": { "method": "GET", "path": "/technical", "has_query": true, "has_filters": true }
    },
    {
      "timestamp": "2026-02-18T10:30:00.102000Z",
      "step": "auth_check",
      "message": "No auth required for GET endpoint",
      "data": { "result": "pass" }
    },
    {
      "timestamp": "2026-02-18T10:30:00.103000Z",
      "step": "validation",
      "message": "Query parameters validated",
      "data": { "result": "pass", "params_present": "q,category,page" }
    },
    {
      "timestamp": "2026-02-18T10:30:00.104000Z",
      "step": "decision",
      "message": "Search query present — using vector search path",
      "data": { "path": "vector_search" }
    },
    {
      "timestamp": "2026-02-18T10:30:00.105000Z",
      "step": "cache_lookup",
      "message": "Embedding cache lookup",
      "data": { "cache_type": "embedding_cache", "result": "miss" }
    },
    {
      "timestamp": "2026-02-18T10:30:00.300000Z",
      "step": "external_api_call",
      "message": "Vertex AI embedding generated",
      "data": { "service": "vertex_ai", "operation": "embed", "latency_ms": 195, "status": "success" }
    },
    {
      "timestamp": "2026-02-18T10:30:00.310000Z",
      "step": "state_change",
      "message": "Embedding vector obtained and L2-normalized",
      "data": { "variable": "embedding_vector", "dimensions": 2048 }
    },
    {
      "timestamp": "2026-02-18T10:30:00.500000Z",
      "step": "vector_search",
      "message": "Firestore Native vector search completed",
      "data": { "collection": "technical_article_vectors", "candidates": 15, "distance_threshold": 0.35 }
    },
    {
      "timestamp": "2026-02-18T10:30:00.510000Z",
      "step": "filter_applied",
      "message": "Category filter applied to candidates",
      "data": { "filter_keys": "category", "candidates_before": 15, "candidates_after": 8 }
    },
    {
      "timestamp": "2026-02-18T10:30:00.520000Z",
      "step": "db_query",
      "message": "Fetching full documents from Firestore Enterprise",
      "data": { "collection": "technical_articles", "operation": "find", "doc_ids_count": 8 }
    },
    {
      "timestamp": "2026-02-18T10:30:01.120000Z",
      "step": "error",
      "message": "Firestore Enterprise query timed out",
      "data": { "error_type": "DeadlineExceeded", "source": "articleRepository.FindByIDs", "latency_ms": 600 }
    }
  ]
}
```

**BE-BREADCRUMB Component Acceptance Criteria**:

- **AC-BREADCRUMB-001**: Given an incoming HTTP request, when the middleware initializes, then a new breadcrumb collector is created and attached to the request's `context.Context` with a pre-allocated slice of capacity 50.
- **AC-BREADCRUMB-002**: Given a breadcrumb collector with 50 entries, when a new breadcrumb is recorded, then the oldest entry is evicted (FIFO) and the new entry is appended.
- **AC-BREADCRUMB-003**: Given any function in the request call chain, when it calls the breadcrumb recording API, then it can retrieve the collector from `context.Context` without an additional parameter.
- **AC-BREADCRUMB-004**: Given a request that completes successfully (no error), when the response is sent, then the breadcrumb buffer is discarded and no breadcrumb data is logged.
- **AC-BREADCRUMB-005**: Given a request that results in an internal error, when the error log entry is emitted, then it includes a `server_breadcrumbs` array with all breadcrumb entries recorded during processing.
- **AC-BREADCRUMB-006**: Given a database query breadcrumb, when the entry is recorded, then filter field **names** (keys) are present but filter **values** are NOT (privacy constraint).
- **AC-BREADCRUMB-007**: Given a breadcrumb entry, when it records a client IP address, then the IP is truncated (last octet zeroed for IPv4, last 80 bits zeroed for IPv6).
- **AC-BREADCRUMB-008**: Given breadcrumb recording overhead, when measured under normal conditions, then the total added latency does not exceed 1 millisecond per request.

#### Response Format

- API responses SHALL use the following `Content-Type` headers based on endpoint:

| Endpoint                    | Success Content-Type | Notes                                      |
| --------------------------- | -------------------- | ------------------------------------------ |
| `GET /`                     | `text/markdown`      | Raw markdown content                       |
| `GET /technical`            | `application/json`   | Paginated list                             |
| `GET /technical/{slug}.md`  | `text/markdown`      | Markdown with YAML front matter            |
| `GET /blog`                 | `application/json`   | Paginated list                             |
| `GET /blog/{slug}.md`       | `text/markdown`      | Markdown with YAML front matter            |
| `GET /socials`              | `application/json`   | Social links list                          |
| `GET /others`               | `application/json`   | Paginated list                             |
| `GET /categories`           | `application/json`   | Categories list                            |
| `GET /sitemap.xml`          | `application/xml`    | XML sitemap                                |
| `GET /robots.txt`           | `text/plain`         | Robots exclusion protocol                  |
| `GET /health`               | `application/json`   | Health check (internal only)               |
| `GET /images/{path}`        | `image/*`            | Proxied image from Cloud Storage (CLR-104) |
| `POST /t`                   | `application/json`   | Tracking/error reporting                   |

- Error responses (4xx, 5xx) SHALL always use `Content-Type: application/json` regardless of the endpoint's success content type.
- The `text/markdown` endpoints return content that resembles accessing a `.md` file directly, with metadata encoded as YAML front matter where applicable.

---

### Endpoints

#### BE-API-001: `GET /`

**Description**: Returns the front page content.

**Request**: No parameters.

**Response** (`200`):

- Content-Type: `text/markdown`
- Body: Raw markdown content of the front page (no JSON wrapping, no YAML front matter).

**Behavior**:

- THE SYSTEM SHALL fetch the front page markdown content from the database.
- THE SYSTEM SHALL return the raw markdown string as the response body with `Content-Type: text/markdown`.
- IF the content is not found, THE SYSTEM SHALL return `404`.

---

#### BE-API-002: `GET /technical`

**Description**: Returns a paginated list of technical blog articles.

**Query Parameters**:

| Parameter    | Type    | Required | Description                                    |
| ------------ | ------- | -------- | ---------------------------------------------- |
| `page`       | integer | No       | Page number (default: 1)                       |
| `q`          | string  | No       | Search query (max 300 characters)              |
| `category`   | string  | No       | Filter by category                             |
| `tags`       | string  | No       | Comma-separated list of tags to filter by      |
| `tag_match`  | string  | No       | Tag matching logic when multiple tags are specified: `all` (AND — article must have ALL specified tags) or `any` (OR — article must have at least ONE specified tag). Default: `any`. |
| `date_from`  | string  | No       | Start of date range for `date_updated` (ISO 8601 date, e.g. `2025-01-01`) |
| `date_to`    | string  | No       | End of date range for `date_updated` (ISO 8601 date)              |

**Validation**:

- IF `q` exceeds 300 characters, THE SYSTEM SHALL return `400`.
- IF `page` is not a positive integer, THE SYSTEM SHALL return `400`.
- IF `date_from` or `date_to` is not valid ISO 8601, THE SYSTEM SHALL return `400`.
- IF `tag_match` is provided and is not `all` or `any`, THE SYSTEM SHALL return `400`.

**Response** (`200`):

```json
{
  "items": [
    {
      "title": "Article Title",
      "slug": "article-title-2025-01-15-1030",
      "category": "DevOps",
      "abstract": "Brief summary of the article...",
      "tags": ["go", "cloud-run", "docker"],
      "date_created": "2025-01-15T10:30:00Z",
      "date_updated": "2025-06-20T14:00:00Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 5,
    "total_items": 42,
    "page_size": 10
  }
}
```

**Behavior**:

- THE SYSTEM SHALL return exactly 10 items per page (fixed, not configurable by the client).
- WHEN the `q` parameter is NOT present, THE SYSTEM SHALL sort results by `date_updated` in descending order (most recently updated first).
- WHEN the `q` parameter IS present, THE SYSTEM SHALL sort results by vector similarity (cosine distance ascending — most relevant first). The `date_updated` field SHALL NOT influence sort order when a search query is active.
- These are the only sort orders; no `sort_by` or `sort_order` parameters are accepted.
- WHEN the `q` parameter is present, THE SYSTEM SHALL use vector similarity search (see **Vector Search Flow** below) instead of text search.
- WHEN the `q` parameter is NOT present, THE SYSTEM SHALL query Firestore Enterprise directly, applying any filters (category, tags, date range).
- IF the search/filter yields no results, THE SYSTEM SHALL return `200` with an empty `items` array and `pagination.total_items` of `0`. Example response:

```json
{
  "items": [],
  "pagination": {
    "current_page": 1,
    "total_pages": 0,
    "total_items": 0,
    "page_size": 10
  }
}
```

- Reserve `404` for truly missing individual resources (e.g., invalid slug in detail endpoints like `GET /technical/{slug}.md`).

**Vector Search Flow** (when `q` parameter is present):

THE SYSTEM SHALL execute the following steps when processing a search query:

1. **Normalize**: Convert the search query to lowercase.
2. **Generate cache key**: Compute UUID v5 from the lowercased query using the URL namespace (`6ba7b811-9dad-11d1-80b4-00c04fd430c8`) and the lowercased query as the name.
3. **Check embedding cache**: Look up the UUID in the `embedding_cache` collection (DM-011) in Firestore Enterprise.
   - **Cache hit**: Verify the cached entry's `model_version` matches the current model version. If it matches, use the cached embedding vector. If it does not match, treat as a cache miss (re-generate embedding and update the cache entry). (CLR-136)
   - **Cache miss**: Call Vertex AI Gemini `gemini-embedding-001` API with `task_type=RETRIEVAL_QUERY` and `output_dimensionality=2048` to generate a 2048-dimensional embedding vector. L2-normalize the vector before storage. Store the UUID, normalized vector, and current `model_version` in the `embedding_cache` collection (no search string stored). No cache expiration.
4. **Vector search**: Query the appropriate Firestore Native collection (`technical_article_vectors`, `blog_article_vectors`, or `others_vectors` — see DM-012) using the embedding vector with `findNearest()` (cosine distance). Exclude results with cosine distance > **0.35** (configurable threshold — see AD-020).
5. **Apply filters**: If additional filters are present (`category`, `tags`, `tag_match`, `date_from`, `date_to`), query Firestore Enterprise with the candidate document IDs from step 4 AND the filter criteria applied. If no filters, retrieve full documents from Firestore Enterprise by document IDs.
6. **Sort**: Sort results by cosine distance ascending (most similar first).
7. **Paginate**: Apply frontend pagination (page number × page size of 10) to the filtered result set. Compute `total_items` and `total_pages` from the filtered set.

> **Note**: When `q` is present without filters, the system maps the frontend page number directly to Firestore Native vector search pagination (offset/limit). When `q` is present with filters, the system fetches all candidate IDs within the distance threshold (up to a hard limit of 500), filters in Firestore Enterprise, and paginates the filtered results.

> **Reference — Distance Threshold**: The default cosine distance threshold of 0.35 (cosine similarity ≥ 0.65) balances recall and precision for semantic article search. This value should be validated empirically with real content and tuned if needed. See: https://cloud.google.com/vertex-ai/generative-ai/docs/embeddings/get-text-embeddings and https://cloud.google.com/firestore/native/docs/vector-search

---

#### BE-API-003: `GET /technical/{slug}.md`

**Description**: Returns a single technical blog article.

**Path Parameters**:

| Parameter | Type   | Description                                    |
| --------- | ------ | ---------------------------------------------- |
| `slug`    | string | Article slug in format: `{title-slug}-{ISO8601-datetime}` |

**Validation**:

- IF the URL does not end with `.md`, THE SYSTEM SHALL return `404`.
- IF the slug does not match the prescribed pattern, THE SYSTEM SHALL return `404`.
  - Slug pattern: `^[a-z0-9]+(?:-[a-z0-9]+)*-\d{4}-\d{2}-\d{2}-\d{4}\.md$`
  - Example: `my-first-article-2025-01-15-1030.md`
- IF the article does not exist in the database, THE SYSTEM SHALL return `404`.

**Response** (`200`):

- Content-Type: `text/markdown`
- Body: Markdown document with YAML front matter containing article metadata, followed by the article body.

**Example Response Body**:

    ---
    title: Article Title
    author: TJ Monserrat
    date_created: "2025-01-15T10:30:00Z"
    date_updated: "2025-06-20T14:00:00Z"
    category: DevOps
    tags:
      - go
      - cloud-run
      - docker
    changelog:
      - date: "2025-06-20T14:00:00Z"
        description: Updated code examples for Go 1.23
      - date: "2025-01-15T10:30:00Z"
        description: Initial publication
    citations:
      apa: "Monserrat, T.J. (2025). Article Title. tjmonsi.com. https://tjmonsi.com/technical/article-title-2025-01-15-1030.md"
      mla: "Monserrat, TJ. \"Article Title.\" tjmonsi.com, 15 Jan. 2025, https://tjmonsi.com/technical/article-title-2025-01-15-1030.md."
      chicago: "Monserrat, TJ. \"Article Title.\" tjmonsi.com. January 15, 2025. https://tjmonsi.com/technical/article-title-2025-01-15-1030.md."
      bibtex: "@online{monserrat2025articletitle, author={Monserrat, TJ}, title={Article Title}, year={2025}, url={https://tjmonsi.com/technical/article-title-2025-01-15-1030.md}}"
      ieee: "T.J. Monserrat, \"Article Title,\" tjmonsi.com, Jan. 15, 2025. [Online]. Available: https://tjmonsi.com/technical/article-title-2025-01-15-1030.md"
    ---

    <article markdown body content>

**Response Headers** (on `200`):

| Header           | Value                                                    |
| ---------------- | -------------------------------------------------------- |
| `Content-Type`   | `text/markdown`                                          |
| `ETag`           | Hash of the response body (e.g., MD5 or SHA-256)         |
| `Last-Modified`  | `date_updated` formatted as HTTP date (e.g., `Wed, 20 Jun 2025 14:00:00 GMT`) |

**Conditional Request Support**:

- WHEN the client sends an `If-None-Match` header with a previously received `ETag` value, THE SYSTEM SHALL return `304 Not Modified` with an empty body if the article content has not changed.
- WHEN the client sends an `If-Modified-Since` header with a date, THE SYSTEM SHALL return `304 Not Modified` if the article's `date_updated` is not more recent than the provided date.
- This enables the frontend's cache-first offline strategy (FE-COMP-008) to efficiently check for updates without re-downloading unchanged content.

**Behavior**:

- THE SYSTEM SHALL return the article as a `text/markdown` response with YAML front matter containing metadata and the article body below the front matter delimiter (`---`).
- THE SYSTEM SHALL generate citation strings dynamically from article metadata (title, author, date, slug).
- Citations SHALL be generated in all supported formats: APA, MLA, Chicago, BibTeX, and IEEE.
- Citation URLs SHALL include the `.md` extension, matching the frontend route format (e.g., `https://tjmonsi.com/technical/article-title-2025-01-15-1030.md`).
- Both the frontend route (`/technical/slug.md`) and the backend API path (`GET /technical/{slug}.md`) use the `.md` extension, presenting a consistent URL to users and search engines as if accessing a markdown file.
- The frontend SHALL parse the YAML front matter to extract metadata (title, author, category, tags, changelog, citations) and render the markdown body separately.

---

#### BE-API-004: `GET /blog`

**Description**: Returns a paginated list of opinion/blog articles.

**Behavior**: Identical to BE-API-002 but queries the blog/opinions table instead of the technical table.

All query parameters, validation rules, response format, error handling, and **vector search flow** (when `q` is present) are the same as BE-API-002. The vector search queries the `blog_article_vectors` Firestore Native collection instead of `technical_article_vectors`.

---

#### BE-API-005: `GET /blog/{slug}.md`

**Description**: Returns a single opinion/blog article.

**Behavior**: Identical to BE-API-003 but queries the blog/opinions table instead of the technical table.

All path parameters, validation rules, response format (including `text/markdown` with YAML front matter), conditional request support (ETag, Last-Modified, 304 Not Modified), and error handling are the same as BE-API-003. Citation URLs use the `/blog/` path prefix (e.g., `https://tjmonsi.com/blog/slug.md`).

---

#### BE-API-006: `GET /socials`

**Description**: Returns a list of social media links.

**Request**: No parameters.

**Response** (`200`):

```json
{
  "items": [
    {
      "platform": "GitHub",
      "url": "https://github.com/tjmonsi",
      "display_name": "@tjmonsi",
      "icon": "github",
      "sort_order": 1
    },
    {
      "platform": "LinkedIn",
      "url": "https://linkedin.com/in/tjmonsi",
      "display_name": "TJ Monserrat",
      "icon": "linkedin",
      "sort_order": 2
    }
  ]
}
```

**Behavior**:

- THE SYSTEM SHALL return social links filtered to only include entries where `is_active` is `true` in the database.
- THE SYSTEM SHALL return items sorted by `sort_order` in ascending order.
- IF no active social links exist, THE SYSTEM SHALL return an empty `items` array (HTTP 200).

---

#### BE-API-007: `GET /others`

**Description**: Returns a paginated list of external/notable content.

**Behavior**: Identical to BE-API-002 in terms of query parameters, pagination, validation, error handling, and **vector search flow** (when `q` is present), but queries the "others" collection. The vector search queries the `others_vectors` Firestore Native collection. Date range filter applies to `date_updated`.

**Response item differences**:

```json
{
  "items": [
    {
      "title": "External Article Title",
      "slug": "external-article-2025-03-10-0800",
      "category": "Open Source",
      "abstract": "Description of the external content...",
      "tags": ["python", "colab"],
      "date_created": "2025-03-10T08:00:00Z",
      "date_updated": "2025-03-10T08:00:00Z",
      "external_url": "https://github.com/tjmonsi/project"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 2,
    "total_items": 15,
    "page_size": 10
  }
}
```

> **Note**: Unlike technical/blog articles, items in `/others` link to external URLs rather than internal article pages.

---

#### BE-API-008: `GET /categories`

**Description**: Returns the list of all categories across all article types.

**Request**: No parameters.

**Response** (`200`):

```json
{
  "categories": [
    {
      "name": "DevOps",
      "date_created": "2025-01-10T08:00:00Z"
    },
    {
      "name": "Cloud",
      "date_created": "2025-02-15T12:00:00Z"
    }
  ]
}
```

**Behavior**:

- THE SYSTEM SHALL return all categories from the `categories` collection, sorted alphabetically by name.
- Categories are free-form and derived from the categories assigned to articles across all article types.
- IF no categories exist, THE SYSTEM SHALL return an empty array.
- The frontend SHALL cache the response in sessionStorage for 24 hours.

---

#### BE-API-009: `POST /t`

**Description**: Receives anonymous visitor tracking data and frontend error reports. This is the **only POST endpoint** in the entire API.

**Authentication**:

- THE SYSTEM SHALL require a valid JWT in the `token` field of the JSON request body.
- The JWT SHALL be generated by the frontend using a static client ID and static secret embedded (obfuscated) in the frontend code.
- THE SYSTEM SHALL validate the JWT signature, expiration, and issuer claims.
- THE SYSTEM SHALL allow a clock skew tolerance of **60 seconds** when validating `exp` and `iat` claims, to accommodate minor clock drift between client and server.
- IF the `token` field is missing, empty, or the JWT is invalid or expired, THE SYSTEM SHALL return HTTP `403 Forbidden`.
- The JWT SHALL include the following claims:
  - `iss`: Static client identifier (e.g., `"tjmonsi-web"`)
  - `iat`: Issued-at timestamp
  - `exp`: Expiration timestamp (short-lived, e.g., 5 minutes)
- The JWT secret SHALL be stored as an environment variable on the backend. The same secret is embedded (obfuscated) in the frontend bundle.

**Request Body** (JSON, `Content-Type: application/json`):

All requests MUST include the `visitor_session_id` and `token` fields:

- `visitor_session_id` (string, required): A UUID v4 generated by the frontend per browser session and stored in `sessionStorage`. This value is random and not derived from any user-identifiable information. It is used by the backend to compute a `visitor_id` hash for unique visitor counting.
- `token` (string, required): A short-lived JWT (5-minute expiry) generated by the frontend using a static client ID and secret (see SEC-003A). The backend validates this token before processing the request.

For page tracking:
```json
{
  "action": "page_view",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "visitor_session_id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "page": "/technical",
  "referrer": "https://google.com",
  "browser": "Chrome 120",
  "connection_speed": {
    "effective_type": "4g",
    "downlink": 10.0,
    "rtt": 50
  }
}
```

For link click tracking:
```json
{
  "action": "link_click",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "visitor_session_id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "page": "/technical/my-article-2025-01-15-1030.md",
  "clicked_url": "https://github.com/example/repo",
  "browser": "Chrome 120",
  "connection_speed": {
    "effective_type": "4g",
    "downlink": 10.0,
    "rtt": 50
  }
}
```

For time-on-page milestone tracking:
```json
{
  "action": "time_on_page",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "visitor_session_id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "page": "/technical/my-article-2025-01-15-1030.md",
  "milestone": "1min",
  "browser": "Chrome 120",
  "connection_speed": {
    "effective_type": "4g",
    "downlink": 10.0,
    "rtt": 50
  }
}
```

For error reporting:
```json
{
  "action": "error_report",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "visitor_session_id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
  "page": "/technical/my-article-2025-01-15-1030.md",
  "browser": "Chrome 120",
  "error_type": "network",
  "error_message": "Failed to fetch article content",
  "connection_speed": {
    "effective_type": "3g",
    "downlink": 1.5,
    "rtt": 300
  },
  "breadcrumbs": [
    {
      "timestamp": "2026-02-18T10:29:55.100Z",
      "type": "navigation",
      "message": "Navigated from / to /technical",
      "data": { "from": "/", "to": "/technical" }
    },
    {
      "timestamp": "2026-02-18T10:29:58.200Z",
      "type": "api_request",
      "message": "GET /technical",
      "data": { "method": "GET", "path": "/technical" }
    },
    {
      "timestamp": "2026-02-18T10:29:58.500Z",
      "type": "api_error",
      "message": "GET /technical failed: network error",
      "data": { "method": "GET", "path": "/technical", "error": "Failed to fetch" }
    }
  ]
}
```

**Validation**:

- `token` is required (string, a valid JWT). Authentication validation is performed before field validation (see SEC-003A).
- `action` is required and must be one of: `page_view`, `link_click`, `time_on_page`, `error_report`.
- `visitor_session_id` is required (string, must be a valid UUID v4 format, max 36 characters).
- `page` is required (string, max 500 characters).
- `browser` is required (string, max 200 characters).
- `clicked_url` is required when `action` is `link_click` (string, max 2000 characters).
- `milestone` is required when `action` is `time_on_page` and must be one of: `1min`, `2min`, `5min`.
- `referrer` is optional (string, max **2000 characters**). IF the value exceeds 2000 characters, THE SYSTEM SHALL truncate it to 2000 characters before processing (CLR-122).
- `error_type` is required when `action` is `error_report` (string, max **100 characters**). IF the value exceeds 100 characters, THE SYSTEM SHALL truncate it to 100 characters before processing (CLR-122).
- `error_message` is optional when `action` is `error_report` (string, max **2000 characters**). IF the value exceeds 2000 characters, THE SYSTEM SHALL truncate it to 2000 characters before processing (CLR-122).
- `connection_speed` is optional (object). Allowed keys: `effective_type` (string, max 10 characters, must be one of: `slow-2g`, `2g`, `3g`, `4g`), `downlink` (number, range 0–1000), `rtt` (integer, range 0–60000). Unknown keys SHALL be ignored. IF the object does not conform to this schema (e.g., invalid `effective_type` value or out-of-range numbers), the non-conforming fields SHALL be dropped from the logged entry (CLR-122). Note: the frontend converts from the browser Navigator.connection API's camelCase field names (e.g., `effectiveType`) to snake_case (e.g., `effective_type`) before sending (CLR-130).
- `breadcrumbs` is optional when `action` is `error_report` (array of objects, max 50 entries). Each entry SHALL contain `timestamp` (string, ISO 8601), `type` (string, max 50 characters), `message` (string, max 300 characters), and optionally `data` (object with string or number values only). If more than 50 entries are provided, THE SYSTEM SHALL truncate to the last 50. If `breadcrumbs` is provided for actions other than `error_report`, it SHALL be ignored.
- All other fields are optional.
- IF validation fails, THE SYSTEM SHALL return HTTP `400`.

**Response** (`200`):

```json
{
  "status": "ok"
}
```

**Behavior**:

- THE SYSTEM SHALL extract the client IP from `X-Forwarded-For` or the connection source.
- THE SYSTEM SHALL add a server-side UTC timestamp.
- THE SYSTEM SHALL perform a GeoIP country lookup on the full (un-truncated) client IP address using a GeoIP database (e.g., MaxMind GeoLite2-Country). The resolved **country code** (ISO 3166-1 alpha-2, e.g., `PH`, `US`, `SG`) SHALL be included in the structured log entry as a `geo_country` field. IF the lookup fails or yields no result, `geo_country` SHALL be set to `"unknown"`. The full IP address is NOT stored; only the country code is retained. This lookup occurs before IP truncation (CLR-123).
- THE SYSTEM SHALL compute a `visitor_id` by generating a SHA-256 hash of the concatenation of: `visitor_session_id` + truncated IP address + raw `User-Agent` header. The resulting hash SHALL be truncated to the first 32 hexadecimal characters. This `visitor_id` is included in every structured log entry emitted by this endpoint. It serves as a privacy-preserving, non-reversible session-scoped identifier used for unique visitor counting and bot traffic discrimination.
- IF `action` is `"page_view"`, THE SYSTEM SHALL emit a structured log entry with `log_type: "frontend_tracking"` containing the tracking payload fields (page, referrer, action, browser, connection_speed, truncated IP, geo_country, timestamp, visitor_id). This log entry flows to BigQuery via the `sink-frontend-tracking` log sink (INFRA-010e).
- IF `action` is `"link_click"`, THE SYSTEM SHALL emit a structured log entry with `log_type: "frontend_tracking"` containing the click payload fields (page, clicked_url, action, browser, connection_speed, truncated IP, geo_country, timestamp, visitor_id). This log entry flows to BigQuery via the `sink-frontend-tracking` log sink (INFRA-010e).
- IF `action` is `"time_on_page"`, THE SYSTEM SHALL emit a structured log entry with `log_type: "frontend_tracking"` containing the engagement payload fields (page, milestone, action, browser, connection_speed, truncated IP, geo_country, timestamp, visitor_id). This log entry flows to BigQuery via the `sink-frontend-tracking` log sink (INFRA-010e).
- IF `action` is `"error_report"`, THE SYSTEM SHALL emit a structured log entry with `log_type: "frontend_error"` containing the error payload fields (error_type, error_message, page, browser, connection_speed, breadcrumbs, truncated IP, geo_country, timestamp, visitor_id). The `breadcrumbs` array (if present) SHALL be included in the structured log entry as-is. This log entry flows to BigQuery via the `sink-frontend-errors` log sink (INFRA-010c).
- THE SYSTEM SHALL NOT write tracking or error report data to Firestore. Structured logging to stdout is the sole persistence mechanism; Cloud Logging routes these entries to BigQuery.
- THE SYSTEM SHALL apply the standard rate limiting rules to this endpoint (see SEC-002).

---

#### BE-API-010: `GET /health`

**Description**: Health check endpoint used by Cloud Run for liveness/readiness probes.

**Request**: No parameters.

**Response** (`200`):

```json
{
  "status": "ok"
}
```

**Behavior**:

- THE SYSTEM SHALL check database connectivity and return `200` with `{"status": "ok"}` if healthy.
- IF the database is unreachable, THE SYSTEM SHALL return `503 Service Unavailable`.
- This endpoint SHALL NOT be subject to application-level rate limiting.
- This endpoint SHALL be accessible only through Cloud Run's internal health check mechanism (not exposed to public traffic via the Load Balancer).

---

#### BE-API-011: `GET /sitemap.xml`

**Description**: Returns the pre-generated sitemap XML. The sitemap is generated periodically by a Cloud Scheduler job and stored in Firestore.

**Request**: No parameters.

**Response** (`200`):

- Content-Type: `application/xml`
- Body: Standard XML sitemap per the [Sitemaps protocol](https://www.sitemaps.org/protocol.html)

**Behavior**:

- THE SYSTEM SHALL fetch the latest sitemap document from the `sitemap` Firestore collection.
- THE SYSTEM SHALL return the sitemap XML content with `Content-Type: application/xml`.
- THE SYSTEM SHALL set `Cache-Control: public, max-age=3600` (1 hour) to reduce database reads for repeated requests.
- IF the sitemap document does not exist in the database, THE SYSTEM SHALL return `404`.
- THE SYSTEM SHALL NOT regenerate the sitemap on each request. Regeneration is handled by a Cloud Scheduler job (see INFRA-008 in [05-infrastructure-specifications.md](05-infrastructure-specifications.md)).
- This endpoint SHALL be subject to the standard rate limiting rules.

---

#### BE-API-012: `GET /robots.txt`

**Description**: Returns the robots exclusion protocol file for the API subdomain (`api.tjmonsi.com`). Blocks all crawlers from the API subdomain.

**Request**: No parameters.

**Response** (`200`):

- Content-Type: `text/plain`
- Body:

      User-agent: *
      Disallow: /

**Behavior**:

- THE SYSTEM SHALL return the robots.txt content with `Content-Type: text/plain`.
- THE SYSTEM SHALL set `Cache-Control: public, max-age=86400` (1 day).
- This endpoint is subject to the standard Cloud Armor rate limiting (60 req/min per IP). Practically, bots requesting `robots.txt` at normal intervals would never be rate-limited.

---

#### BE-API-013: `GET /images/{path}`

**Description**: Serves images from the Cloud Storage media bucket (`<project-id>-media-bucket`, INFRA-019) by proxying the binary content through the Go backend. This enables article markdown to reference images via `https://api.tjmonsi.com/images/...` while keeping the CSP `img-src` restrictive (CLR-104).

**Request**:

- `{path}` (string, required): The object path within the media bucket. May include nested directories (e.g., `articles/diagram.png`, `2025/photo.webp`).

**Response** (`200`):

- Content-Type: The original MIME type of the image as stored in Cloud Storage (e.g., `image/png`, `image/webp`, `image/jpeg`, `image/svg+xml`).
- Body: Raw image bytes.
- `Cache-Control: public, max-age=2592000` (30 days).

**Behavior**:

- THE SYSTEM SHALL read the requested object from the `<project-id>-media-bucket` Cloud Storage bucket using the Cloud Storage Go SDK.
- THE SYSTEM SHALL stream the object bytes directly to the HTTP response without buffering the entire image in memory.
- THE SYSTEM SHALL set the `Content-Type` response header to the object's content type as reported by Cloud Storage.
- THE SYSTEM SHALL set `Cache-Control: public, max-age=2592000` (30 days) on all successful responses. Downstream caching (browser cache, Cloud CDN if configured) is the sole caching mechanism for image responses; there is no application-level in-memory cache (CLR-121).
- IF the requested path does not exist in the bucket, THE SYSTEM SHALL return HTTP `404`.
- IF an internal error occurs while reading from Cloud Storage, THE SYSTEM SHALL return `404` to the client and log the actual error (consistent with the error masking strategy).
- THE SYSTEM SHALL validate the `{path}` parameter to prevent path traversal attacks (e.g., reject paths containing `..`).
- THE SYSTEM SHALL only serve objects with image MIME types (`image/*`). IF the object's content type is not an image, THE SYSTEM SHALL return `404`.
- This endpoint SHALL be subject to the standard rate limiting rules.

---

### General API Notes

- **Author field**: The `author` field in article responses (BE-API-003, BE-API-005) is always hardcoded to `"TJ Monserrat"`. This is a single-author website; the author value is not stored in the database.
- **Offline availability**: The backend does not track which articles are available offline. Offline availability is a client-side concern managed by the frontend's service worker and local storage.
- **Sitemap generation**: Sitemap regeneration is handled by a dedicated Cloud Function (see INFRA-008 in [05-infrastructure-specifications.md](05-infrastructure-specifications.md)). The Cloud Function runs internally, queries article collections from Firestore, and writes the generated sitemap XML to the `sitemap` collection. The Go backend API only reads and serves the pre-generated sitemap via `GET /sitemap.xml` (BE-API-011).
- **No detail endpoint for `/others`**: The `others` collection does not have a `GET /others/{slug}.md` detail endpoint. Items in `/others` link directly to external URLs. When the user clicks an item in the list, they are navigated to the external website.

---

### Rate Limiting

See [06-security-specifications.md](06-security-specifications.md) for full rate limiting specifications.

---

### Acceptance Criteria

- **AC-API-001**: Given a valid `GET /technical` request, when articles exist, then the response returns `200` with `application/json` containing a paginated list with `items`, `total_items`, `page`, `page_size`, `total_pages`.
- **AC-API-002**: Given a valid `GET /technical/{slug}.md` request, when the article exists, then the response returns `200` with `text/markdown` including YAML front matter and the full article body.
- **AC-API-003**: Given a `GET /technical/{slug}.md` request with `If-None-Match` matching the current `ETag`, when the article has not changed, then the response returns `304 Not Modified` with no body.
- **AC-API-004**: Given a valid `POST /t` request with a valid `token` field in the body and `action: "page_view"`, when processed, then the response returns `200` with `{"status": "ok"}` and a structured log entry is emitted.
- **AC-API-005**: Given a `POST /t` request with a missing or invalid `token` field, when processed, then the response returns `403 Forbidden`.
- **AC-API-006**: Given a request with an unsupported HTTP method on any endpoint, when processed, then the response returns `405 Method Not Allowed` with an `Allow` header.
- **AC-API-007**: Given an internal server error in any endpoint, when the error occurs, then the client receives `404` (not `500`) and the actual error is logged to Cloud Logging.
- **AC-API-008**: Given a valid `GET /images/{path}` request, when the image exists in the media bucket, then the response returns `200` with the image bytes, correct `Content-Type`, and `Cache-Control: public, max-age=2592000`.
- **AC-API-009**: Given a `GET /images/{path}` request with a path containing `..`, when processed, then the response returns `404` (path traversal rejected).
- **AC-API-010**: Given a `GET /images/{path}` request for a non-image object, when processed, then the response returns `404`.
- **AC-API-011**: Given a valid `GET /sitemap.xml` request, when a sitemap exists in Firestore, then the response returns `200` with `application/xml` and `Cache-Control: public, max-age=3600`.
- **AC-API-012**: Given a valid `POST /t` request with a `referrer` value exceeding 2000 characters, when processed, then the `referrer` is truncated to 2000 characters in the emitted structured log entry (CLR-122).
- **AC-API-013**: Given a `GET /technical` request without a `q` parameter, when articles exist, then the response items are sorted by `date_updated` descending (most recently updated first).
- **AC-API-014**: Given a `GET /technical` request with a `q` parameter, when matching articles exist, then the response items are sorted by vector similarity (cosine distance ascending — most relevant first), not by `date_updated`.
- **AC-API-015**: Given a `GET /blog` request without a `q` parameter, when articles exist, then the response items are sorted by `date_updated` descending.
- **AC-API-016**: Given a `GET /blog` request with a `q` parameter, when matching articles exist, then the response items are sorted by vector similarity (cosine distance ascending), not by `date_updated`.
- **AC-API-017**: Given a `GET /others` request without a `q` parameter, when items exist, then the response items are sorted by `date_updated` descending.
- **AC-API-018**: Given a `GET /others` request with a `q` parameter, when matching items exist, then the response items are sorted by vector similarity (cosine distance ascending), not by `date_updated`.
- **AC-API-019**: Given any API request that results in an internal error, when the error is logged to Cloud Logging, then the log entry includes a `server_breadcrumbs` array containing the chronological processing steps (request received, validation, database queries, cache lookups, external API calls, decisions) that occurred before the error.
- **AC-API-020**: Given an API request that completes successfully, when the response is sent, then no breadcrumb data is persisted or logged (breadcrumbs are discarded on success).
- **AC-API-021**: Given an API request processing a vector search with filters (`GET /technical?q=...&category=...`), when an error occurs during the database query step, then the `server_breadcrumbs` in the error log show each step: request received, validation, embedding cache lookup, Vertex AI call (if cache miss), vector search results, filter application, and the failing database query — with latency measurements for each step.
- **AC-API-022**: Given the breadcrumb trail records a database query, when the log is inspected, then filter field names (keys) are present but filter values are NOT present (privacy constraint).
- **AC-API-GEO-001**: Given a `POST /t` request, when the backend processes the request, then it SHALL resolve `geo_country` from the client IP address prior to truncation using the embedded GeoIP database; only the country code is retained — the full IP is discarded immediately after lookup. The resolved `geo_country` is included in the structured log entry. (CLR-137, CLR-144)
- **AC-API-GEO-002**: Given a `POST /t` request where the GeoIP lookup fails or returns no result, then the system SHALL set `geo_country` to `"unknown"` in the structured log entry. (CLR-137)
